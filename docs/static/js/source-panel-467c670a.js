var ae=Object.defineProperty,le=Object.defineProperties;var se=Object.getOwnPropertyDescriptors;var W=Object.getOwnPropertySymbols;var ie=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable;var K=(e,o,t)=>o in e?ae(e,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[o]=t,M=(e,o)=>{for(var t in o||(o={}))ie.call(o,t)&&K(e,t,o[t]);if(W)for(var t of W(o))de.call(o,t)&&K(e,t,o[t]);return e},R=(e,o)=>le(e,se(o));import{Q as re,t as ce,H as ue,R as L,q as E,K as pe,_ as ge,y as me,z as fe,G as _e,S as ve}from"./index-0ca6328d.js";import{u as H}from"./useSchemaStore-487cf8d0.js";import{M as F}from"./chunk-bin-ui-next-c6b728c8.js";import{B as ye,k,G as De,a1 as q,as as j,H as v,o as d,a as u,b as a,f as O,F as A,O as V,c as f,w as D,e as $,m as G,t as S,j as z,s as T,h as be,g as Ce,v as he,x as Y,l as B,I as we,D as Ie,E as Ne,az as Te,aA as Se}from"./vendor-1e0971ef.js";import"./chunk-brace-269ffce0.js";import"./database.api-f0f62620.js";const ke={ASC:"\u5347\u5E8F",DESC:"\u964D\u5E8F"},Me={SUM:"\u6C42\u548C",MAX:"\u6700\u5927\u503C",MIN:"\u6700\u5C0F\u503C",AVG:"\u5E73\u5747\u6570",COUNT:"\u8BA1\u6570",COUNTD:"\u53BB\u91CD\u8BA1\u6570"};function Ee(e,o){const t=ye({loading:!1,dimensionTree:{},measureTree:{},xColumns:[],yColumns:[],drill:[],filters:[],dragging:!1}),{selectedCom:i}=H(),p=k(()=>i.value.apiData),_=k(()=>p.value.config.modelId),m=k(()=>t.xColumns.findIndex(l=>l.drillEnabled==="Y")>-1),c=l=>{const{dimension:g,measure:w}=l||{};t.dimensionTree=g||{title:"\u7EF4\u5EA6",nodeType:"root",children:[]},t.measureTree=w||{title:"\u5EA6\u91CF",nodeType:"root",children:[]},_.value===e.selectedModelId&&(t.xColumns=E(p.value.config.x),t.yColumns=E(p.value.config.y),t.drill=E(p.value.config.drill))};(async()=>{t.loading=!0;try{const l=await re(e.selectedModelId);c(l)}catch(l){ce("useDsApi/initData",l)}t.loading=!1})();const y=(l,g,w)=>!1,r=l=>l.nodeType==="attribute",C=l=>ue(l.target,"drag-enter"),h=l=>L(l.target,"drag-enter");let n="",s=null;function I(l){t.dragging=!0,n="D",s=l}function N(l){t.dragging=!0,n="M",s=l}function P(){return{tableId:s.tableId,tableName:s.tableName,field:s.field,fieldId:s.fieldId,title:s.title,type:s.type,dataType:s.dataType,sortWay:"",drillEnabled:"N"}}function X(l){const g=t.xColumns.length;for(let U=0;U<g;U++)t.xColumns[U].drillEnabled=U===l?"Y":"N";const w=t.xColumns[l];t.drill=[{tableId:w.tableId,tableName:w.tableName,field:w.field,fieldId:w.fieldId,title:w.title,type:w.type,dataType:w.dataType}]}function J(l){if(l===0){t.drill=[];for(let g=0;g<t.xColumns.length;g++)t.xColumns[g].drillEnabled="N"}else t.drill.splice(l,1)}function Z(l){l.preventDefault(),L(l.target,"drag-enter"),n==="D"&&(t.xColumns.find(g=>g.fieldId===s.fieldId)?F.warning("\u5DF2\u5B58\u5728\u540C\u540D\u5B57\u6BB5\uFF01\u65E0\u9700\u91CD\u590D\u914D\u7F6E\u3002"):t.xColumns.push(M({},P()))),s=null}function x(l){l.preventDefault(),L(l.target,"drag-enter"),n==="M"&&(t.yColumns.find(g=>g.fieldId===s.fieldId)?F.warning("\u5DF2\u5B58\u5728\u540C\u540D\u5B57\u6BB5\uFF01\u65E0\u9700\u91CD\u590D\u914D\u7F6E\u3002"):t.yColumns.push(R(M({},P()),{aggregator:"SUM"}))),s=null}function ee(l){l.preventDefault(),L(l.target,"drag-enter"),n==="D"&&(t.drill.find(g=>g.fieldId===s.fieldId)?F.warning("\u5DF2\u5B58\u5728\u540C\u540D\u5B57\u6BB5\uFF01\u65E0\u9700\u91CD\u590D\u914D\u7F6E\u3002"):t.drill.push({tableId:s.tableId,tableName:s.tableName,field:s.field,fieldId:s.fieldId,title:s.title,type:s.type,dataType:s.dataType})),s=null}function oe({index:l,key:g}){t.xColumns[l].sortWay=g}function te({index:l,key:g}){t.yColumns[l].aggregator=g}function ne(){p.value.config.modelId=e.selectedModelId,p.value.config.modelName=e.selectedModelName,p.value.config.x=E(q(t.xColumns)),p.value.config.y=E(q(t.yColumns)),p.value.config.drill=E(q(t.drill)),o("save")}return R(M({},De(t)),{SORT_FUN:ke,AGGREGATOR_FUN:Me,showDrill:m,onDragEnter:C,onDragLeave:h,allowDrop:y,allowDrag:r,handleDimensionDragStart:I,handleMeasureDragStart:N,onDimensionDrop:Z,onMeasureDrop:x,onDrillDrop:ee,sortChange:oe,aggrChange:te,setDrill:X,removeDrill:J,setApiDataConfig:ne})}const Ae=["VBasicBar","VHorizontalBar","VBasicLine","VBasicArea"],Ve={name:"ds-api",emits:["save"],props:{selectedModelId:{type:String,required:!0},selectedModelName:{type:String,required:!0}},setup(e,{emit:o}){const{selectedCom:t}=H(),i=k(()=>Ae.includes(t.value.name));function p({root:_,node:m,data:c}){const b=[Y("span",{class:`${c.type} t-ellipsis`,style:{width:"calc(100% - 24px)"},flex:"cross:center",title:`${c.title}-(${c.field})`},[c.nodeType!=="root"?Y("i",{type:c.dataType,size:"14px",style:{marginRight:"6px"}}):null,c.title])];return Y("span",{style:{width:"100%",fontSize:"12px"},flex:"main:justify"},b)}return R(M({renderContent:p},Ee(e,o)),{canDrill:i})}},$e={class:"data-source-api"},Re={class:"data-config-left"},ze={class:"config-data-container"},Be={class:"config-data-panel"},Ge=a("div",{class:"area-name D"},[a("span",null,"\u7C7B\u522B\u8F74/\u7EF4\u5EA6")],-1),Ue={key:0,class:"no-column-tip"},Le=a("span",{title:"\u62D6\u52A8\u7EF4\u5EA6\u5B57\u6BB5\u81F3\u6B64\u5904"},"\u62D6\u52A8\u7EF4\u5EA6\u5B57\u6BB5\u81F3\u6B64\u5904",-1),Oe=[Le],Fe={key:1,class:"column-list dimension",id:"area_type"},He={class:"field-title"},qe={key:0,class:"b-iconfont b-icon-expand mr-5",title:"\u4E0B\u94BB\u5B57\u6BB5"},Ye={class:"ml-5"},je=G("\u4E0D\u6392\u5E8F"),Pe=["onClick"],We=["onClick"],Ke=a("div",{class:"area-name M"},[a("span",null,"\u503C\u8F74/\u5EA6\u91CF")],-1),Qe={key:0,class:"no-column-tip"},Xe=a("span",{title:"\u62D6\u52A8\u5EA6\u91CF\u5B57\u6BB5\u81F3\u6B64\u5904"},"\u62D6\u52A8\u5EA6\u91CF\u5B57\u6BB5\u81F3\u6B64\u5904",-1),Je=[Xe],Ze={key:1,class:"column-list measure",id:"area_value"},xe={class:"field-title"},eo={class:"ml-5"},oo=["onClick"],to=a("div",{class:"area-name",flex:"cross:center"},[a("span",{class:"mr-5"},"\u4E0B\u94BB\u5B57\u6BB5"),a("i",{class:"b-iconfont b-icon-question-circle f-s-14",title:"\u53EF\u7EE7\u7EED\u62D6\u62FD\u7EF4\u5EA6\u5B57\u6BB5\u8BBE\u7F6E\u4E0B\u5C42\u4E0B\u94BB\u5B57\u6BB5"})],-1),no={class:"column-list drill-list"},ao={class:"field-title"},lo={key:0,class:"b-iconfont b-icon-branches mr-5 f-s-14"},so={class:"ml-5"},io=["onClick"],ro={class:"bottom-menus"},co={class:"refresh-panel"},uo=G("\u4FDD \u5B58"),po={class:"data-config-right"},go={class:"tree-box"},mo={class:"tree-box"},fo={class:"tree-loading"};function _o(e,o,t,i,p,_){const m=v("field-type-icon"),c=v("b-dropdown-item"),b=v("b-dropdown-menu"),y=v("b-dropdown"),r=v("b-button"),C=v("b-tree"),h=v("g-loading");return d(),u("div",$e,[a("div",Re,[a("div",ze,[a("div",Be,[a("div",{class:O(["node-main",{dragging:e.dragging}])},[a("div",{id:"area_type_panel",class:"config-data-item",onDrop:o[3]||(o[3]=n=>e.onDimensionDrop(n))},[Ge,e.xColumns.length===0?(d(),u("div",Ue,Oe)):(d(),u("ul",Fe,[(d(!0),u(A,null,V(e.xColumns,(n,s)=>(d(),u("li",{key:n.id,class:O(["column-item",n.type])},[f(y,{trigger:"contextmenu","append-to-body":"",onCommand:e.sortChange},{dropdown:D(()=>[f(b,null,{default:D(()=>[f(c,{name:{index:s,key:""},selected:n.sortWay===""},{default:D(()=>[je]),_:2},1032,["name","selected"]),(d(!0),u(A,null,V(e.SORT_FUN,(I,N)=>(d(),$(c,{key:N,name:{index:s,key:N},selected:n.sortWay===N},{default:D(()=>[G(S(I),1)]),_:2},1032,["name","selected"]))),128))]),_:2},1024)]),default:D(()=>[a("div",He,[e.showDrill&&n.drillEnabled==="Y"?(d(),u("i",qe)):z("",!0),f(m,{type:n.dataType,size:"14px"},null,8,["type"]),a("span",Ye,S(n.title),1)])]),_:2},1032,["onCommand"]),i.canDrill&&!e.showDrill&&n.drillEnabled==="N"?(d(),u("i",{key:0,class:"b-iconfont b-icon-apartment",title:"\u8BBE\u7F6E\u4E0B\u94BB",onClick:I=>e.setDrill(s)},null,8,Pe)):z("",!0),a("i",{class:"b-iconfont b-icon-delete",onClick:I=>e.xColumns.splice(s,1)},null,8,We)],2))),128))])),a("div",{class:"config-data-item-mask",onDragover:o[0]||(o[0]=T(()=>{},["prevent"])),onDragenter:o[1]||(o[1]=T((...n)=>e.onDragEnter&&e.onDragEnter(...n),["stop"])),onDragleave:o[2]||(o[2]=T((...n)=>e.onDragLeave&&e.onDragLeave(...n),["stop"]))},null,32)],32),a("div",{id:"area_value_panel",class:"config-data-item",onDrop:o[7]||(o[7]=n=>e.onMeasureDrop(n))},[Ke,e.yColumns.length===0?(d(),u("div",Qe,Je)):(d(),u("ul",Ze,[(d(!0),u(A,null,V(e.yColumns,(n,s)=>(d(),u("li",{key:n.id,class:O(["column-item",n.type])},[f(y,{trigger:"contextmenu","append-to-body":"",onCommand:e.aggrChange},{dropdown:D(()=>[f(b,null,{default:D(()=>[(d(!0),u(A,null,V(e.AGGREGATOR_FUN,(I,N)=>(d(),$(c,{key:N,name:{index:s,key:N},selected:n.aggregator===N},{default:D(()=>[G(S(I),1)]),_:2},1032,["name","selected"]))),128))]),_:2},1024)]),default:D(()=>[a("div",xe,[f(m,{type:n.dataType,size:"14px"},null,8,["type"]),a("span",eo,S(n.title)+S(` (${e.AGGREGATOR_FUN[n.aggregator]})`),1)])]),_:2},1032,["onCommand"]),a("i",{class:"b-iconfont b-icon-delete",onClick:I=>e.yColumns.splice(s,1)},null,8,oo)],2))),128))])),a("div",{class:"config-data-item-mask",onDragover:o[4]||(o[4]=T(()=>{},["prevent"])),onDragenter:o[5]||(o[5]=T((...n)=>e.onDragEnter&&e.onDragEnter(...n),["stop"])),onDragleave:o[6]||(o[6]=T((...n)=>e.onDragLeave&&e.onDragLeave(...n),["stop"]))},null,32)],32),e.showDrill&&e.drill.length>0?(d(),u("div",{key:0,id:"area_drill_panel",class:"config-data-item",onDrop:o[11]||(o[11]=n=>e.onDrillDrop(n))},[to,a("ul",no,[(d(!0),u(A,null,V(e.drill,(n,s)=>(d(),u("li",{key:n.id,class:O(["column-item",n.type]),style:be({width:s===0?"100%":"90%"})},[a("div",ao,[s===0?(d(),u("i",lo)):z("",!0),f(m,{type:n.dataType,size:"14px"},null,8,["type"]),a("span",so,S(n.title),1)]),a("i",{class:"b-iconfont b-icon-delete",onClick:I=>e.removeDrill(s)},null,8,io)],6))),128))]),a("div",{class:"config-data-item-mask",onDragover:o[8]||(o[8]=T(()=>{},["prevent"])),onDragenter:o[9]||(o[9]=T((...n)=>e.onDragEnter&&e.onDragEnter(...n),["stop"])),onDragleave:o[10]||(o[10]=T((...n)=>e.onDragLeave&&e.onDragLeave(...n),["stop"]))},null,32)],32)):z("",!0)],2)]),a("div",ro,[a("div",co,[f(r,{type:"primary",style:{width:"100%"},onClick:e.setApiDataConfig},{default:D(()=>[uo]),_:1},8,["onClick"])])])])]),a("div",po,[a("div",go,[f(C,{"default-expand":"",draggable:"","lock-select":"","allow-drop":e.allowDrop,"allow-drag":e.allowDrag,data:[e.dimensionTree],render:i.renderContent,onNodeDragStart:e.handleDimensionDragStart,onNodeDragEnd:o[12]||(o[12]=n=>e.dragging=!1)},null,8,["allow-drop","allow-drag","data","render","onNodeDragStart"])]),a("div",mo,[f(C,{"default-expand":"",draggable:"","lock-select":"","allow-drop":e.allowDrop,"allow-drag":e.allowDrag,data:[e.measureTree],render:i.renderContent,onNodeDragStart:e.handleMeasureDragStart,onNodeDragEnd:o[13]||(o[13]=n=>e.dragging=!1)},null,8,["allow-drop","allow-drag","data","render","onNodeDragStart"])]),Ce(a("div",fo,[f(h,{spinning:"",type:"square"})],512),[[he,e.loading]])])])}var vo=j(Ve,[["render",_o]]);const yo={name:"source-drawer",components:{DsApi:vo},emits:["close"],setup(e,{emit:o}){const t=B(!1),{selectedCom:i}=H(),p=k(()=>i.value.apiData),_=B(""),m=B("");return{visible:t,apiDataConfig:p,open:({modelId:y,modelName:r})=>{t.value=!0,_.value=y,m.value=r},close:()=>{t.value=!1,_.value="",m.value="",o("close")},selectedModelId:_,selectedModelName:m}}};function Do(e,o,t,i,p,_){const m=v("ds-api"),c=v("b-drawer");return d(),$(c,{modelValue:i.visible,"onUpdate:modelValue":o[0]||(o[0]=b=>i.visible=b),"class-name":"source-drawer","append-to-body":"",width:500,title:`\u6A21\u578B [${i.selectedModelName}] \u914D\u7F6E`,styles:{padding:0},"mask-closable":!1,onClose:i.close},{default:D(()=>[i.visible?(d(),$(m,{key:0,"selected-model-id":i.selectedModelId,"selected-model-name":i.selectedModelName,onSave:i.close},null,8,["selected-model-id","selected-model-name","onSave"])):z("",!0)]),_:1},8,["modelValue","title","onClose"])}var bo=j(yo,[["render",Do]]);const Co={name:"source-panel",components:{SourceDrawer:bo,DataEditor:pe(()=>ge(()=>import("./data-editor-2657d2bf.js"),["static/js/data-editor-2657d2bf.js","static/css/data-editor-fea543a8.css","static/js/vendor-1e0971ef.js","static/css/vendor-2b79d43b.css","static/js/chunk-brace-269ffce0.js"]))},setup(){const e=B("260px"),o=B(null),t=we("ModelTree",[]),i=k(()=>{const y=r=>{const C=_.value.config?_.value.config.modelId:"",h=R(M({},r),{icon:r.directory==="Y"?"folder":r.modelType==="DM"?"deploymentunit":"database",selected:C===r.id});return r.children&&r.children.length&&(h.children=r.children.map(y)),h};return t.value.map(y)}),{selectedCom:p}=H(),_=k(()=>p.value.apiData),m=y=>{_.value.config.data=y},c=()=>{e.value=`${document.body.clientHeight-260}px`},b=(y,r)=>{var C;r.directory==="Y"?(r.selected=!1,F.warning("\u4E0D\u80FD\u9009\u62E9\u6587\u4EF6\u5939\uFF01")):(_.value.config.modelId===r.id&&(r.selected=!0),(C=o.value)==null||C.open({modelId:r.id,modelName:r.name}))};return Ie(()=>{c(),me(window,"resize",c)}),Ne(()=>{fe(window,"resize",c)}),{staticEditorHeight:e,sourceDrawerRef:o,ApiType:_e,apiDataConfig:_,modelTree:i,handleChange:b,ApiTypeMap:ve(),updateData:m}}},Q=e=>(Te("data-v-b11bb852"),e=e(),Se(),e),ho={class:"api-editor"},wo={class:"attr-source-wp"},Io={class:"data-source"},No=Q(()=>a("div",{class:"data-result-title"},"\u6570\u636E\u6E90\u914D\u7F6E",-1)),To={class:"data-source-config"},So={key:1,class:"pt-10"},ko=Q(()=>a("div",{class:"data-result-title"},"\u9009\u62E9\u5206\u6790\u6A21\u578B",-1)),Mo={class:"p16"};function Eo(e,o,t,i,p,_){const m=v("b-radio"),c=v("b-radio-group"),b=v("g-field"),y=v("data-editor"),r=v("b-tree"),C=v("source-drawer");return d(),u("div",ho,[a("div",wo,[a("div",Io,[No,a("div",To,[f(b,{label:"\u6570\u636E\u6765\u6E90"},{default:D(()=>[f(c,{modelValue:i.apiDataConfig.type,"onUpdate:modelValue":o[0]||(o[0]=h=>i.apiDataConfig.type=h),type:"button",size:"mini"},{default:D(()=>[(d(!0),u(A,null,V(i.ApiTypeMap,(h,n)=>(d(),$(m,{key:n,label:n},{default:D(()=>[G(S(h),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])]),_:1}),i.apiDataConfig.type===i.ApiType.static?(d(),$(y,{key:0,"model-value":i.apiDataConfig.config.data,height:i.staticEditorHeight,onChange:i.updateData},null,8,["model-value","height","onChange"])):(d(),u("div",So,[ko,a("div",Mo,[f(r,{data:i.modelTree,titleKey:"name","default-expand":"",onSelectChange:i.handleChange},null,8,["data","onSelectChange"])])]))])])]),f(C,{ref:"sourceDrawerRef"},null,512)])}var Uo=j(Co,[["render",Eo],["__scopeId","data-v-b11bb852"]]);export{Uo as default};
